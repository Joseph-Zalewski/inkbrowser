<!DOCTYPE html>
<html>
<title>Sdbrowser Client</title>
<!--This html contains the main client code for sdbrowser. It can:-->
<!--To Do:
	JSON decode - X?
	Add listeners - X
	Host this page from Flask - X
	Send queries to Python server - X
	Create View class - X
	Create graph view - X
	Display query output - X
	Encapsulate functions - X
	Set up message bus - X
	Encapsulate mxGraph imports
	Preliminary message format - X
	Create triple list view
	Create object list view - X
	Fix style on the tree view output
	Access hyperlinks in query output??
	Make paths to mxGraph source code platform-independent
	CoModIDE translator
	Arrow Type?
	To Do on Flask End:
	Host a JSON file??
-->
<head>

	
	<script type="text/javascript">
		mxBasePath = '/static/mxgraph/javascript/src';
	</script>
	
	<script type="text/javascript">
		JSONtestinput = '{"Boxes": [{"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake", "XOffset": 142.85714285714286, "YOffset": 500.0, "XSize": 70, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Earthquake", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Point", "XOffset": 460.3174603174603, "YOffset": 400.0, "XSize": 45, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Point", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Point> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#TemporalEntity", "XOffset": 436.5079365079365, "YOffset": 269.2307692307692, "XSize": 90, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "TemporalEntity", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#TemporalEntity> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Instant", "XOffset": 412.6984126984127, "YOffset": 176.92307692307693, "XSize": 55, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Instant", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Instant> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Interval", "XOffset": 500.0, "YOffset": 176.92307692307693, "XSize": 60, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Interval", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Interval> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Observation", "XOffset": 134.9206349206349, "YOffset": 276.9230769230769, "XSize": 75, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Observation", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Observation> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Geometry", "XOffset": 452.3809523809524, "YOffset": 500.0, "XSize": 60, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "Geometry", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Geometry> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservationCollection", "XOffset": 119.04761904761905, "YOffset": 384.61538461538464, "XSize": 125, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "ObservationCollection", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservationCollection> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservableProperty", "XOffset": 119.04761904761905, "YOffset": 100.0, "XSize": 110, "YSize": 30, "FillColorHex": "#ffff00", "TextColorHex": "#000000", "Label": "ObservableProperty", "Query": "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?X WHERE { ?X rdf:type <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservableProperty> }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}], "Arrows": [{"Id": 13, "Label": "isFeatureOfInterestOf", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservationCollection", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#isFeatureOfInterestOf> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample", "Waypoints": [[237.39468864468864, 459.1529304029304]]}, {"Id": 14, "Label": "hasGeometry", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Geometry", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#hasGeometry> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 15, "Label": "phenomenonTime", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#TemporalEntity", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#phenomenonTime> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 16, "Label": "subClassOf", "ArrowType": "Hollow", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Point", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Geometry", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.w3.org/2000/01/rdf-schema#subClassOf> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 17, "Label": "asWKT", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Point", "Target": "http://www.w3.org/2001/XMLSchema#string", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#asWKT> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 18, "Label": "subClassOf", "ArrowType": "Hollow", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Instant", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#TemporalEntity", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.w3.org/2000/01/rdf-schema#subClassOf> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 19, "Label": "dateTime", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Instant", "Target": "http://www.w3.org/2001/XMLSchema#dateTime", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#dateTime> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 20, "Label": "subClassOf", "ArrowType": "Hollow", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Interval", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#TemporalEntity", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.w3.org/2000/01/rdf-schema#subClassOf> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 21, "Label": "observedProperty", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Observation", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservableProperty", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#observedProperty> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 22, "Label": "hasSimpleResult", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Observation", "Target": "http://www.w3.org/2001/XMLSchema#string", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#hasSimpleResult> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}, {"Id": 23, "Label": "hasFeatureOfInterest", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservationCollection", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Earthquake", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#hasFeatureOfInterest> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample", "Waypoints": [[122.01007326007328, 455.46245421245425]]}, {"Id": 24, "Label": "hasMember", "ArrowType": "Solid", "Source": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#ObservationCollection", "Target": "http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#Observation", "Query": "SELECT ?X ?Z WHERE { ?X <http://www.semanticweb.org/luzhou/ontologies/2021/4/untitled-ontology-15#hasMember> ?Z }", "Limit": 50, "Endpoint": "http://localhost:3030/sample"}], "Mode": "DEFAULT", "CanvasX": 500, "CanvasY": 500}';
	</script>
	
	<script type="text/javascript" src={{url_for('static', filename='mxgraph/javascript/mxClient.js')}}></script>
	
	<script type="text/javascript">
		//viewArray is global. See 'trigger' below.
		var viewArray = window.parent.viewArray;
		//generates unique identifiers for view objects
		var currentIdentifier = 0;
		function nextIdentifier(){
			currentIdentifier = currentIdentifier + 1;
			return currentIdentifier;
		}
	
		////Class declarations
		//View class. Represents any independent part of the user interface. Since this is Javascript, subclasses can take arbitrary additional constructor parameters containing information such as the DOM node or DOM nodes they will use to display themselves. However, View has one distinguished parameter, collection, which takes a collection of Views. Subclasses can send messages to other views in this collection by calling their processNotify method. This class should be considered abstract and never instantiated except in the constructor of a subclass.
		function View(collection){
			this.collection = collection;
			collection.push(this);
			this.identifier = nextIdentifier();
		}
		View.prototype.processNotify = function(){};
		//end View class
		
		//GraphView subclass.
		function GraphView(collection, DOMNode){
			View.call(this, collection);
			this.DOMNode = DOMNode;
			//holds identifiers of Views that receive data from this one
			this.recipients = [];
		}
		GraphView.prototype = Object.create(View.prototype);
		Object.defineProperty(GraphView.prototype, 'constructor', {value: GraphView, enumerable: false, writable: true,});
		Object.defineProperty(GraphView.prototype, 'JSONToGraph', {value: 
		//Contract: Parameters: String JSONString.
		//Constructs the mxGraph encoded by JSONString, if there is one, displaying it in the DOM element this.DOMNode.
		function(JSONString)
		{	
			var pageElement = this.DOMNode;
			var schema = JSON.parse(JSONString);
			if (!mxClient.isBrowserSupported())
			{
				mxUtils.error('Browser is not supported!', 200, false);
			}
			else{
				mxEvent.disableContextMenu(pageElement);
				var diagram = new mxGraph(pageElement);
				var parent = diagram.getDefaultParent();
				var nodes = {};
				var edges = {};
				diagram.getModel().beginUpdate();
				try{
					for(var b of schema.Boxes){
						nodes[b.Id] = diagram.insertVertex(parent, null, b.Label,b.XOffset,b.YOffset,b.XSize,b.YSize, 'fontColor='+b.TextColorHex+';fillColor='+b.FillColorHex+';'+b.AdditionalMxStyle);
					}
					
					for(var e of schema.Arrows){
						//create edgestyle for this edge
						mxEdgeStyle['sd'+e.Id] = this.constructEdgestyle(e);
						mxStyleRegistry.putValue('sd'+e.Id, mxEdgeStyle['sd'+e.Id]);
						//mxUtils.error(mxStyleRegistry.getValue('sd'+e.Id), 200, false);
						//insert the edge
						edges[e.Id] = diagram.insertEdge(parent, null, e.Label, nodes[e.Source], nodes[e.Target], 'edgeStyle=sd'+e.Id+';'+e.AdditionalMxStyle);
					}
					var collection = this.collection;
					pageElement.onclick = function(){diagram.fireEvent(new mxEventObject('click'));};
					diagram.addListener(mxEvent.CLICK, function(sender, evt)
					{
						var e = evt.getProperty('event');
						var cell = evt.getProperty('cell');
						if(cell != null){
							for(b of schema.Boxes){
								if(nodes[b.Id] == cell){
								var q = b.Query + ' LIMIT ' + b.Limit;
								var box = b;
									AJAXQuery(q, box.Endpoint,
										function(str){
											var msg = {text: str, query: box.Query, limit: box.Limit, endpoint: box.Endpoint};
											for(var V of collection){
												V.processNotify(msg);
											}
											});
								}
							}
							for(e of schema.Arrows){
								if(edges[e.Id] == cell){
								var q = e.Query + ' LIMIT ' + e.Limit;
								var edge = e;
									AJAXQuery(q, edge.Endpoint,
										function(str){
											var msg = {text: str, query: edge.Query, limit: edge.Limit, endpoint: edge.Endpoint};
											for(var V of collection){
												V.processNotify(msg);
											}
											});
								}
							}
						}
					});
				}
				catch(err){
					errorDiv.innerHTML = err.toString();
				}
				finally{
					diagram.getModel().endUpdate();
				}
			}
		}});
		Object.defineProperty(GraphView.prototype, 'constructEdgestyle', {value:
		//Contract: e is an Arrow object extracted, e.g., from a parsed internal JSON representation. Returns an mxEdgestyle which encodes the routing information for e, based on e.Waypoints, if that field is defined. Otherwise returns the default mxGraph elbow style.
		function(e)
		{	
			var style;
			if(e.Waypoints){
				style = function(state,source,target,points,result){
					for(var pt of e.Waypoints){
						result.push(new mxPoint(pt[0],pt[1]));
					}
				}
			}else{
				style = mxEdgeStyle.ElbowConnector;
			}
			return style;
		}});
		//end GraphView subclass
		
		
		
		//Contract: Query is a string. It is intended to be a SPARQL query, but that will be checked on the server. callback must be a function capable of taking a string argument. endpoint should be a URL to a SPARQL endpoint on which the query can be run. If the AJAX query terminates successfully, possibly after this function returns, callback() will be called on the response.
		function AJAXQuery(query, endpoint, callback){
			request = new XMLHttpRequest();
			request.open('POST', '/query', true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send('query='+query+'&endpoint='+endpoint);

			request.onreadystatechange = function(){
				//alert('readystate changed, status'+this.status.toString());
				if(this.readyState == 4 && this.status == 200){
					//alert('Response received:'+request.responseText);
					callback(request.responseText);
				}
			}

		}
		//this function is a hook for buttons and other HTML elements to access the view objects through their message bus.
		function trigger(identifier, msg){
			for (var view of viewArray){
				if (view.identifier == identifier)
				{
					view.processNotify(msg);
				}
			}
		}
		
		function main(){
			var GV = new GraphView(viewArray, document.getElementById('GraphDiv'));
			GV.JSONToGraph(JSONtestinput);
		}
	</script>
</head>


<body onload="main()">


<div id="GraphDiv"></div>


</body>
</html>