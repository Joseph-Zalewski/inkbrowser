<!DOCTYPE html>
<html>
<title>Sdbrowser Client</title>
<!--This html contains the main client code for sdbrowser. It can:-->
<!--To Do:
	JSON decode - X?
	Add listeners - X
	Host this page from Flask - X
	Send queries to Python server - X
	Create View class - X
	Create graph view - X
	Display query output - X
	Encapsulate functions - X
	Set up message bus - X
	Encapsulate mxGraph imports
	Preliminary message format - X
	Create triple list view
	Create object list view - X
	Fix style on the tree view output
	Access hyperlinks in query output??
	Make paths to mxGraph source code platform-independent
	CoModIDE translator - X
	Arrow Type?
	Make Arrow Label Position controllable
	make graph components non-draggable
	To Do on Flask End:
	Host a JSON file??
-->
<head>
	<!-- Names ending in names of View subclassses, e.g. ulTreeView, should be reserved, as CSS class names. Page elements with class xxxYYYView should only be used in HTML generated by class YYYView or intended to interact with it. -->
	<style>
		.ulTreeView {
			list-style-type: none;
		}
		.plusTreeView{
			cursor: pointer;
		}
		.plusTreeView::before{
			content:"+";
		}
		.minusTreeView::before{
			content:"-";
		}
		.nested{
			display: none;
		}
		.active{
			display: block;
		}
	</style>
	
	
	<script type="text/javascript">
		mxBasePath = '/static/mxgraph/javascript/src';
	</script>
	
	<script type="text/javascript">
		JSONtestinput = '{ 	"Boxes":[ 		{"Id":"Source", 		"XOffset":100, 		"YOffset":100, 		"XSize":70, 		"YSize":30, 		"FillColorHex":"#ffffff", 		"TextColorHex":"#ff0000", 		"Label":"Source",    "Query":"PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT ?X WHERE { <http://dbpedia.org/resource/Asturias> rdfs:label ?X }", 		"Limit":10, 		"Endpoint":"http://dbpedia.org/sparql" 		}, 		 		{"Id":"Sink", 		"XOffset":200, 		"YOffset":300, 		"XSize":70, 		"YSize":30, 		"FillColorHex":"#ef99ef", 		"TextColorHex":"#ff0000", 		"Label":"Sink"} 	], 	"Arrows":[ 		{"Id":"Primary", 		"LabelX":200, 		"LabelY":200, 		"Label":"Primary", 		"ArrowType":"Hollow", 		"Source":"Source", 		"Target":"Sink", 		"Waypoints":[ 				[200,200], 				[220,200] 			] 		}, 		 		{"Id":"Segundo", 		"LabelX":200, 		"LabelY":200, 		"Label":"Secondary", 		"ArrowType":"Solid", 		"Source":"Source", 		"Target":"Sink", 		"Waypoints":[ 				[400,200], 				[20,500], 				[30,750] 			], 		"Query":"PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT ?X WHERE { <http://dbpedia.org/resource/Asturias> rdfs:label ?X }", 		"Limit":10, 		"Endpoint":"http://dbpedia.org/sparql" 		} 	], 	"Mode":"DEFAULT", "CanvasX":500, "CanvasY":500 }';
	</script>
	
	<script type="text/javascript" src={{url_for('static', filename='mxgraph/javascript/mxClient.js')}}></script>
	
	<script type="text/javascript">
		//viewArray is global. See 'trigger' below.
		var viewArray = [];
		//generates unique identifiers for view objects
		var currentIdentifier = 0;
		function nextIdentifier(){
			currentIdentifier = currentIdentifier + 1;
			return currentIdentifier;
		}
	
		////Class declarations
		//View class. Represents any independent part of the user interface. Since this is Javascript, subclasses can take arbitrary additional constructor parameters containing information such as the DOM node or DOM nodes they will use to display themselves. However, View has one distinguished parameter, collection, which takes a collection of Views. Subclasses can send messages to other views in this collection by calling their processNotify method. This class should be considered abstract and never instantiated except in the constructor of a subclass.
		function View(collection){
			this.collection = collection;
			collection.push(this);
			this.identifier = nextIdentifier();
		}
		View.prototype.processNotify = function(){};
		//end View class
		

		
		//PlainTextView subclass.
		function PlainTextView(collection, DOMNode){
			View.call(this, collection);
			this.DOMNode = DOMNode;
		}
		PlainTextView.prototype = Object.create(View.prototype);
		Object.defineProperty(PlainTextView.prototype, 'constructor', {value: PlainTextView, enumerable: false, writable: true,});
		PlainTextView.prototype.processNotify = function(msg)
			{this.DOMNode.innerHTML = msg.text;};
		
		
		//end PlainTextView subclass
		
		//ListView subclass
		//displays a list of clickable items
		function ListView(collection, DOMNode){
			View.call(this, collection);
			this.DOMNode = DOMNode;
			this.query = '';
			this.limit = 10;
			this.endpoint = '';
			this.DOMNode.innerHTML = '<div></div><button>Load More Results</button>';
		}
		
		ListView.prototype = Object.create(View.prototype);
		
		Object.defineProperty(ListView.prototype, 'constructor', {value: ListView, enumerable: false, writable: true,});
		
		Object.defineProperty(ListView.prototype, 'processJSONResults', {value: function(str)
		{	
			var div = this.DOMNode.getElementsByTagName("div")[0];
			try{
				input = JSON.parse(str);
				var output;
				var valuesUsed = new Set();
				output ='<ul>';
				for(var result of input.results.bindings){
					if(!valuesUsed.has(result.X.value)){
						output = output + '<li>' + result.X.value + '</li>';
						valuesUsed.add(result.X.value);
					}
				}
				output = output + '</ul>';
				div.innerHTML = output;
				var items = div.getElementsByTagName('li');
				var thisref = this;
				div.addEventListener('click', function(e){
					if(e.target.nodeName.toUpperCase() != 'LI') return;
					//alert(e.target.nodeName);
					var li = e.target;
					var POQuery = "SELECT ?P ?O WHERE { <" + li.innerHTML + "> ?P ?O . }";
					send = function(results){
							var msg = {text:results,query:POQuery,limit:50,endpoint:thisref.endpoint,type:'POresults'};
							for(var view of thisref.collection){
								view.processNotify(msg);
							}
						}
					AJAXQuery(POQuery + ' LIMIT 50', thisref.endpoint, send);
				});
			}
			catch{
				div.innerHTML = '<ul><li>Invalid or Missing Query Results Received!</li></ul>';
			}
		}});
		
		//Needs a query, for a single variable X. ListView will use the query to load more results if needed.
		//By default ListView assumes any text passed to it is a text representation
		//of JSON SPARQL query results for a query with a single variable X, and extract results.bindings.X.value
		//fields from it.
		ListView.prototype.processNotify = function(msg)
			{
				if(msg.type != "Xresults"){
					return;
				}
				if(msg.text != undefined){
					this.processJSONResults(msg.text);
				}
				//if the message has no text, then the ListView assumes it is supposed to run a new query.
				else{
					var thisref = this;
					AJAXQuery(msg.query + ' LIMIT ' + msg.limit, msg.endpoint, function(str){
						thisref.processJSONResults(str);
					});
				}
				this.query = msg.query;
				this.limit = msg.limit;
				this.endpoint = msg.endpoint;
				var thisref = this;
				var tr = function(){
					trigger(thisref.identifier, {query:thisref.query, endpoint:thisref.endpoint, limit:(2*thisref.limit)}, type="Xresults");
				};
				this.DOMNode.getElementsByTagName('button')[0].onclick = tr;
			};
			
			
		//TripleView subclass
		//displays a list of predicate-object pairs
		function TripleView(collection, DOMNode){
			View.call(this, collection);
			this.DOMNode = DOMNode;
			this.query = '';
			this.limit = 10;
			this.endpoint = '';
			this.DOMNode.innerHTML = '<div></div><button>Load More Results</button>';
		}
		
		TripleView.prototype = Object.create(View.prototype);
		
		Object.defineProperty(TripleView.prototype, 'constructor', {value: TripleView, enumerable: false, writable: true,});
		
		Object.defineProperty(TripleView.prototype, 'processJSONResults', {value: function(str)
		{	
			var div = this.DOMNode.getElementsByTagName("div")[0];
			try{
				input = JSON.parse(str);
				var output;
				output ='<table><tr><th>Predicate</th><th>Object</th></tr>';
				for(var result of input.results.bindings){
					output = output + '<tr><td>' + result.P.value + '</td><td>' + result.O.value + '</td></tr>';
				}
				output = output + '</table>';
				div.innerHTML = output;
			}
			catch{
				div.innerHTML = '<ul><li>Invalid or Missing Query Results Received!</li></ul>';
			}
		}});
		
		//Needs a query, for variables P, O. TripleView will use the query to load more results if needed.
		//By default TripleView assumes any text passed to it is a text representation
		//of JSON SPARQL query results for a query with variables P,O.
		TripleView.prototype.processNotify = function(msg)
			{
				if(msg.type != 'POresults') return;
				if(msg.text != undefined){
					this.processJSONResults(msg.text);
				}
				//if the message has no text, then the TripleView assumes it is supposed to run a new query.
				else{
					var thisref = this;
					AJAXQuery(msg.query + ' LIMIT ' + msg.limit, msg.endpoint, function(str){
						thisref.processJSONResults(str);
					});
				}
				this.query = msg.query;
				this.limit = msg.limit;
				this.endpoint = msg.endpoint;
				var thisref = this;
				var tr = function(){
					trigger(thisref.identifier, {query:thisref.query, endpoint:thisref.endpoint, limit:(2*thisref.limit)});
				};
				this.DOMNode.getElementsByTagName('button')[0].onclick = tr;
			};
		
		//TreeView class
		//root is some object, getChildren(node) is some function which takes an object and returns its children as an array; together these specify an abstract tree. It is the instantiator's responsibility to ensure this tree is not infinite. The TreeView displays this tree as an HTML tree. display() is some function that takes nodes of the abstract tree and converts them into strings to display.
		function TreeView(collection, DOMNode, root, getChildren, display, action){
			View.call(this, collection);
			this.root = root;
			this.getChildren = getChildren;
			this.DOMNode = DOMNode;
			this.display = display;
			this.action = action;
			this.setup(this.DOMNode, this.root, this.action);
		}
		
		TreeView.prototype = Object.create(View.prototype);
		
		Object.defineProperty(TreeView.prototype, 'constructor', {value: TreeView, enumerable: false, writable: true,});
		
		//this method creates the TreeView's tree as HTML inside DOMNode and adds appropriate listeners to it.
		Object.defineProperty(TreeView.prototype, 'setup', {value: function(DOMNode, root, action){
			DOMNode.innerHTML = this.expand(root, true);
			var expanders = DOMNode.getElementsByClassName("plusTreeView");
			for (var ex of expanders){
				ex.addEventListener("click", function(){
					this.parentElement.querySelector(".nested").classList.toggle("active");
					this.classList.toggle("minusTreeView");
				});
				ex.addEventListener("dblclick", function(){
					action(this);
				});
			}
		}
		});
		//this method takes an abstract tree node 'node' and returns the subtree rooted at 'node', in HTML form.
		Object.defineProperty(TreeView.prototype, 'expand', {value: function(node, isRoot)
		{	
			var children = this.getChildren(node);
			var ret;
			if (children.length != 0){
				ret = '<span class=\"plusTreeView\">' + this.display(node) + '</span>';
				ret = ret + '<ul class=\"ulTreeView nested\">';
				for(var child of children){
					ret = ret + '<li>'+this.expand(child, false)+'</li>';
				}
				ret = ret + '</ul>';
			}else{
				ret = '<span>' + this.display(node) + '</span>';
			}
			return ret;
		}});
		
		
		
		function textQuerySetup(query, limit, endpoint){
			var div = document.getElementById("textQueryDiv");
			div.addEventListener("click", function(){
				AJAXQuery(query + " LIMIT " + limit, endpoint, function(str){
					var msg = {text: str, query: query, limit: limit, endpoint: endpoint};
					for(var V of viewArray){
						V.processNotify(msg);
					}
				});
			});
		}
		
		
		
		
		//Contract: Query is a string. It is intended to be a SPARQL query, but that will be checked on the server. callback must be a function capable of taking a string argument. endpoint should be a URL to a SPARQL endpoint on which the query can be run. If the AJAX query terminates successfully, possibly after this function returns, callback() will be called on the response.
		function AJAXQuery(query, endpoint, callback){
			request = new XMLHttpRequest();
			request.open('POST', '/query', true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send('query='+query+'&endpoint='+endpoint);

			request.onreadystatechange = function(){
				//alert('readystate changed, status'+this.status.toString());
				if(this.readyState == 4 && this.status == 200){
					//alert('Response received:'+request.responseText);
					callback(request.responseText);
				}
			}

		}
		//this function is a hook for buttons and other HTML elements to access the view objects through their message bus.
		function trigger(identifier, msg){
			for (var view of viewArray){
				if (view.identifier == identifier)
				{
					view.processNotify(msg);
				}
			}
		}
		
		function objectTest(){
			//var GV = new GraphView(viewArray, document.getElementById('graphFrame').contentWindow.document.getElementById('GraphDiv'));
			var LV = new ListView(viewArray, document.getElementById('listFrame').contentWindow.document.getElementById('ListDiv'));
			var TV = new TripleView(viewArray, document.getElementById('tripleFrame').contentWindow.document.getElementById('TripleDiv'));
			//GV.JSONToGraph(JSONtestinput);
			//var TV = new TreeView(viewArray, document.getElementById('treeFrame').contentWindow.document.getElementById('TreeDiv'), 7, function(n){if (n > 1) return [n-1,n-2]; else return [];}, function(n){return n.toString()}, function(n){alert("Number "+n.toString());});
			textQuerySetup("PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT ?X WHERE { <http://dbpedia.org/resource/Asturias> rdfs:label ?X }", 10, "http://dbpedia.org/sparql");
		}
	</script>
</head>


<body onload="objectTest()">
    {% extends "base.html" %}
    {% block content %}
<div id="errorDiv"></div>
<div id="statusDiv"></div>
<div id="plainTextDiv"></div>
<div id="treeDiv"></div>
<div id="textQueryDiv">Click Here</div>
<iframe src="iframeDiv/ListView/ListDiv" id="listFrame" title="List View"
style="width:500px;height:500px;"></iframe>
<iframe src="iframeDiv/TripleView/TripleDiv" id="tripleFrame" title="Triple View"
style="width:500px;height:500px;"></iframe>
<iframe src="graphView" id="graphFrame" title="Graph View"
style="width:500px;height:500px;"></iframe>
<!--<iframe src="iframeDiv/TreeView/TreeDiv" id="treeFrame" title="Tree View"
style="width:500px;height:500px;"></iframe> -->

<form>
	<label>Look up a Schema Diagram:</label>
	<input type="text" id="schemaAddress" style="width:500px;"></input>
</form>
    {% endblock %}
</body>
</html>